/*  lanyrd.js - v0.0.1 
 *  Copyright 2011-2012, Dharmafly <http://dharmafly.com> 
 *  Released under the MIT License 
 *  More Information: https://github.com/dharmafly/lanyrd.js 
 */(function(a,b,c,d){function i(a){a=f.isArray(a)?a:[a];for(var b=0,c=a.length,d;b<c;b+=1){d=a[b];if(d instanceof i||d instanceof j)d=d.get();this[b]=d}this.length=a.length}function j(a){a=a||{},this.url=a.url,this.data=a.data||{};var b=a.deferred||f.deferred();this.url&&(this.fetch=function(a,c){if(this.state()!==j.PENDING)return this;var d=this.url,g,h;return e.requestType===f.request.JSONP&&(d+=(d.indexOf("?")<0?"?":"&")+"callback=?"),g=f.request(d),h=this,g.done(function(){h.data=g.data,b.resolveWith(h,[h,g])}),g.fail(function(){b.rejectWith(h,[h,g])}),this.then(a,c)}),b.promise(this)}"use strict";var e,f,g,h;f={a:c.document&&c.document.createElement("a"),isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},each:function(a,b,c){var d=0,e=typeof a=="object"&&a.length,f;if(typeof e=="number")for(;d<e;d+=1)f=a[d],b.call(c||f,f,d,a);else for(d in a)a.hasOwnProperty(d)&&(f=a[d],b.call(c||f,f,d,a));return a},keys:function(a){return f.map(a,function(a,b){return b})},map:function(a,b,c){var d=[];return f.each(a,function(a){d.push(b?b.apply(this,arguments):a)},c),d},filter:function(a,b,c){var d=[];return f.each(a,function(a){b.apply(this,arguments)&&d.push(a)},c),d},extend:function(a){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=c.length,e=0,f,g;for(;e<d;e+=1){f=c[e];for(g in f)f.hasOwnProperty(g)&&(b[g]=f[g])}return b},invoke:function(a,b){var c=[],d=[].slice.call(arguments,2);return f.each(a,function(a){c.push(a[b].apply(a,d))}),c},pluck:function(a,b,c){var d=[].slice.call(arguments,2);return f.map(a,function(a){return f.keypath(a,b,c)})},deferred:function(){return b&&b.Deferred?new b.Deferred:new f._.Deferred},when:function(a){var c=arguments.length===1&&f.isArray(a)?a:arguments;return b&&b.Deferred?b.when.apply(b,c):f._.when.apply(f._,c)},request:function(a){var b=e.requestType,c=f.rawRequest(a,b),d=f.deferred(),g=d.promise({data:null,type:b,xhr:b===f.request.JSONP?null:c});return c.then(function(a){g.data=a,d[!a||a.error?"reject":"resolve"](g)},function(){d.reject(g)}),g},rawRequest:function(a,c){return c=c||"json",b?b.ajax({url:a,dataType:c}):g.utils[c](a)},escape:function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},keypath:function(b,c,e,f){var g=(c||"").split("."),h;if(!c)return b;while(b&&g.length){h=g.shift();if(!(b.hasOwnProperty(h)||f===!0&&b[h]!==d))break;b=b[h];if(g.length===0&&b!==d)return b}return arguments.length>2?e:null},pathname:function(a){return f.a.href=a||"/",f.a.pathname}},f.request.JSON="json",f.request.JSONP="jsonp",i.prototype={constructor:i,get:function(a,b){return f.keypath(this[0],a,b)},escape:function(a,b){return f.escape(this.get(a,b))},related:function(a){var b=a.split("."),c=b.pop(),d;return b.push("api_urls"),d=this.get(b.join("."),{})[c],d||(d=this.get(a)),d?new j({url:d}):j.noop()},fetchRelated:function(a,b,c){return this.related(a).fetch(b,c)},fetchAllRelated:function(a,c,d){function g(b){return b.fetchRelated(a)}var e=f.deferred();return b.when.apply(b,this.map(g)).then(function(){var a=[],c=[];b.each(arguments,function(){c.push(this[1]),a.push(this[0])}),e.resolve(a,c)},e.reject),e.promise().then(c,d)},at:function(a){return a=a<0?a+this.length:a,this[a]||null}},f.each(["each","map","filter","pluck","invoke"],function(a){i.prototype[a]=function(){return f[a].apply(this,[].concat.apply(this,arguments))}}),j.PREV="prev",j.NEXT="next",j.RESOLVED="resolved",j.REJECTED="rejected",j.PENDING="pending",j.noop=function(a){var b=f.deferred(),c=new j(f.extend({deferred:b},a));return b.rejectWith(c,[c,null]),c},j.prototype={constructor:j,url:null,data:null,fetch:function(){return this},fetched:function(){return this.state&&this.state()===j.RESOLVED},related:function(a){return this.collection().related(a)},get:function(a,b){return f.keypath(this.data,a,b)},escape:function(a,b){return f.escape(this.get(a,b))},collection:function(a){var b=this.get(a);return b&&(b=new i(b)),b},paginate:function(a){var b=this.get("pagination.api_urls",{})[a];return b?new j({url:b}):j.noop()},paginated:function(){return this.get("pagination.num_pages",1)>1},first:function(){return this.get("pagination.page",1)===1},last:function(){var a=this.get("pagination",{});return a.page===a.num_pages},next:function(a,b){return this.paginate(j.NEXT).fetch().then(a,b)},prev:function(a,b){return this.paginate(j.PREV).fetch().then(a,b)},all:function(a,b){function g(){function g(c,g){f-=1;if(f)return;g?d.rejectWith(e,[e,g]):(e.data={},e.data[a]=b,d.resolveWith(e,[e]))}var a=c.get("pagination.paginated_key"),b=[],f=2;(function h(c){return c.flag||(c.flag=!0,d.notifyWith(c,arguments),b=c.get(a).slice().concat(b)),c.prev().then(h,g)})(c),function i(c){return c.flag||(c.flag=!0,d.notifyWith(c,arguments),b=b.concat(c.get(a))),c.next().then(i,g)}(c)}var c=this,d=f.deferred(),e=new j({deferred:d});return this.fetched()?g():this.fetch().always(g),e.then(a,b)}},g={API_DOMAIN:"http://lanyrd.asyncjs.com",conference:function(a){return this.resource({url:this.url(a)})},person:function(a){var b=this.url(a).replace(/\/profile\//i,"/people/");return this.resource({url:b})},place:function(a){return this.resource({url:this.url(a)})},topic:function(a){return this.resource({url:this.url(a)})},collection:function(a){return new i(a)},resource:function(a){return new j(a)},url:function(a){return this.API_DOMAIN+f.pathname(a)},config:function(a){f.extend(e,a)},utils:f,noConflict:function(){return c.lanyrd=a,g},Collection:i,Resource:j},e={requestType:f.request.JSONP},typeof c.define=="function"&&c.define.amd?c.define("lanyrd",function(){return g}):c.exports?(require("./lanyrd/deferred")(f),require("./lanyrd/request")(f),h=require("url").parse,g.utils.pathname=function(a){return h(a).pathname},e.requestType=f.request.JSON,c.exports=g):c.lanyrd=g})(this.lanyrd,this.jQuery,typeof module!="undefined"?module:this),function(a){function d(a){return"http://query.yahooapis.com/v1/public/yql?q=select%20href%2C%20content%20from%20html%20where%20url%3D%22"+encodeURIComponent(a)+"%22%20and%0A%20%20%20%20%20%20xpath%3D'%2F%2Fli%5Bcontains(%40class%2C%22vevent%22)%5D%2F%2Fa%5Bcontains(%40class%2C%22url%22)%5D'"+"&format=json&callback=?"}"use strict";var b="http://lanyrd.com",c=a.utils.jsonp||window.jQuery&&window.jQuery.getJSON;if(a.series)return;a.series=function(e,f,g){var h=[];return c(d(e)).pipe(function(b){var c=new a.utils.deferred,d=c.promise();return b.query.results===null?c.reject(b):c.resolve(b),d}).pipe(function(c){return c.query.results?(a.utils.each(c.query.results.a,function(c){h.push(a.conference(b+c.href).fetch())}),a.utils.when(h)):[]}).done(f).fail(g)}}(this.lanyrd),function(a){"use strict",a.widgets={people:{},person:{}};var b=function(){var a=/{{\s*([a-z0-9_][\\.a-z0-9_]*)\s*}}/gi;return function(b,c){return b.replace(a,function(a,b){for(var d=b.split("."),e=d.length,f=c,h=0;h<e;h++){f=f[d[h]];if(f===void 0)throw"tim: '"+d[h]+"' not found in "+a;if(h===e-1)return f}})}}();a.widgets.people=function(c,d,e){function h(b){return e.all?a.utils.when(b.related("conference.attendees").all(),b.related("conference.trackers").all()):a.utils.when(b.related("conference.attendees").fetch(),b.related("conference.trackers").fetch())}function i(a){d&&(e.append?d.innerHTML+=a:d.innerHTML=a)}function j(c,d){var f=a.utils.deferred(),h=f.promise(),i=e.templates.attendeesHeading||'<h2 class="lanyrd-attendees-title"><a target="_blank" href={{attendees_url}}>{{amount}} attending</a></h2>',j=e.templates.trackersHeading||'<h2 class="lanyrd-trackers-title">{{amount}} tracking</h2>',k=e.templates.people||'<ul class="lanyrd-people {{people_type}}">{{list}}</ul>',l=e.templates.person||'<li><a href="{{web_url}}"><img class="lanyrd-avatar" title="{{name}} ({{username}})" src="{{avatar_url}}"></a></li>',m="",n=function(a,c){var d="",e,f=0;for(f;f<a.length;f++)e=a[f].user||a[f],d+=b(l,e);m+=b(k,{list:d,people_type:c})};return m+=b(i,{amount:c.length,attendees_url:g?g.web_url+"attendees":""}),n(c,"lanyrd-attendees"),d.length>0&&(m+=b(j,{amount:d.length}),n(d,"lanyrd-trackers")),m='<div class="lanyrd-widget"><style>.lanyrd-people, .lanyrd-people li  {padding: 0;margin: 0;}.lanyrd-people, .lanyrd-people li { overflow: hidden;}.lanyrd-people li {list-style: none;float: left;padding-right: 6px;}</style>'+m+"</div>",f.resolve(m),h}var f,g;return e=e||{},e.all=e.all||!0,e.templates||(e.templates={}),a.utils.isArray(c)&&c.length>1?(c=a.utils.map(c,function(b){return a.conference(b).fetch()}),f=a.mergeRelated(c,{related:["attendees","trackers"]}).pipe(function(a){return j(a.attendees,a.trackers).then(i)})):(c+="",f=a.conference(c).fetch().pipe(function(a){return g=a.get("conference"),a}).pipe(h).pipe(function(a,b){return j(a.get("attendees"),b.get("trackers")).then(i)})),f},a.widgets.people.topics=function(a,b,c){},a.widgets.person=function(c,d,e){function f(c){var d=a.utils.deferred(),f=d.promise(),g,h=e.templates.person||'<h2><a href="{{web_url}}">{{name}}</a></h2><img class="lanyrd-avatar" title="{{name}} ({{username}})" src="{{avatar_url}}"><p>{{short_bio}}</p>';return g=b(h,c),d.resolve(g),f}var e=e||{};return e.templates||(e.templates={}),a.person(c).fetch().pipe(function(a){return a.get("user")}).pipe(f).then(function(a){d&&(d.innerHTML=e.append?d.innerHTML+=a:a)})},a.widgets.person.topics=function(c,d,e){function h(c){var d=new a.utils.deferred,f=d.promise(),g=[],h="",i;a.utils.each(c,function(b,d){a.utils.each(e.ignore,function(a){d.toLowerCase()===a.toLowerCase()&&delete c[d]})}),a.utils.each(c,function(a,b){a>=e.cutoff&&g.push([b,a])}),g=g.sort(function(a,b){return b[1]-a[1]}).slice(0,e.amount),g=a.utils.map(g,function(a){return a[0]});for(i=0;i<g.length;i++)h+="<li>"+g[i]+"</li>";return d.resolve(b(e.templates.topics||'<ol class="lanyrd-widget-interests">{{topics}}</ol>',{topics:h}),c),f}var f=a.person(c),g=[],e=e||{};return e.templates||(e.templates={}),e.amount=e.amount||10,e.ignore=e.ignore||[],e.cutoff=e.cutoff||0,e.append=e.append||!1,e.events=e.events,f.fetch().pipe(function(a){if(!e.events)return a.related("user.attending").fetch()}).pipe(function(b){var c=a.utils.map(b.get("conferences_attending"),function(b){return a.resource({url:b.api_urls.conference})});return a.topics(c)}).pipe(function(a){return h(a).then(function(a){d&&(d.innerHTML=e.append?d.innerHTML+=a:a)})})},a.widgets.series=function(c,d,e){function g(c){var d=new a.utils.deferred,f=d.promise(),g="",h=new Date,i={upcoming:[],past:[]};e.amount>0&&(c=c.slice(0,e.amount)),c.length===0&&(g+="<h2>no events found for the series</h2>"),a.utils.each(c,function(a,c){a.conference.end_date+"T23:59:59.000Z">(new Date).toISOString()?i.upcoming.push(b(e.templates.upcomingConference||'<li><a href="{{web_url}}">{{name}}</a></li>',a.conference)):i.past.push(b(e.templates.pastConference||'<li><a href="{{web_url}}">{{name}}</a></li>',a.conference))});if(e.conferences.upcoming){var j=[];for(var k=i.upcoming.length-1;k>=0;k--)j.push(i.upcoming[k]);g+=b(e.templates.upcoming||'<div class="upcoming conferences"><h1>Upcoming Events</h1><ul>{{conferences}}</ul></div>',{conferences:j.join("")})}return e.conferences.past&&(g+=b(e.templates.past||'<div class="past conferences"><h1>Past Events</h1><ul>{{conferences}}</ul></div>',{conferences:i.past.join("")})),d.resolve(b(e.templates.wrapper||'<div class="lanyrd-widget-series">{{content}}</div>',{content:g}),c),f}if(!a.series)throw"Lanyrd series extension isn't loaded!";var f=a.series(c),e=e||{};return e.templates||(e.templates={}),e.conferences||(e.conferences={}),e.amount=e.amount||0,e.append=e.append||!1,e.conferences.upcoming=e.conferences.upcoming||!0,e.conferences.past=e.conferences.past||!0,f.pipe(function(){var b=a.utils.map(arguments,function(a){return a&&a.length&&a[0].data});return g(b).then(function(a){d&&(d.innerHTML=e.append?d.innerHTML+=a:a)})}).fail(function(){var a=e.templates.error||'<div class="lanyrd-widget-series">Error! </div>';d&&(d.innerHTML=a)})},a.widgets.series.topics=function(c,d,e){function f(c){var d=new a.utils.deferred,f=d.promise(),g=[],h="",i;a.utils.each(c,function(b,d){a.utils.each(e.ignore,function(a){d.toLowerCase()===a.toLowerCase()&&delete c[d]})}),a.utils.each(c,function(a,b){a>=e.cutoff&&g.push([b,a])}),g=g.sort(function(a,b){return b[1]-a[1]}).slice(0,e.amount),g=a.utils.map(g,function(a){return a[0]});for(i=0;i<g.length;i++)h+=b(e.templates.topic||"<li>{{topic}}</li>",{topic:g[i]});return d.resolve(b(e.templates.topics||'<ol class="lanyrd-widget-interests">{{topics}}</ol>',{topics:h}),c),f}var e=e||{};return e.templates||(e.templates={}),e.append=e.append||!1,e.amount=e.amount||10,e.ignore=e.ignore||[],e.cutoff=e.cutoff||0,a.series(c).pipe(function(){return a.utils.map(arguments,function(a){return a[0]})}).pipe(a.topics).pipe(function(a){return f(a).then(function(a){d&&(d.innerHTML=e.append?d.innerHTML+=a:a)})})}}(lanyrd),function(a){function f(a,b){for(var c=0,d=a.length;c<d;c+=1)return a[c]===b?!0:!1}var b=a.utils,c=["staff","speakers","attendees","trackers"],d={staff:4,speakers:4,attendees:2,trackers:1},e=0;a.mergeRelated=function(a,g){function k(){var a=[],c=b.keys(j);return b.each(arguments,function(d){var e=b.map(c,function(a){return d[0].collection("conference").related(a).fetch().pipe(function(a){return a.get(a.get("pagination.paginated_key"))})});a=a.concat(e)}),b.when.apply(null,a).pipe(function(){var a=[],d={};return b.each(arguments,function(f,g){var h=g%c.length;d[c[h]]=b.map(f,function(a){return a.user?a.user:(delete a.user,a.username||(a.username="user-"+(e+=1)),a)}),h===c.length-1&&(a.push(d),d={})}),a})}function l(a){function k(a,b){return g.duplicateAttendee!==!1&&a==="attendees"&&f(b,d[a])}function l(a,b){var c=h[b.username];c||(c=h[b.username]=b),d[a]||(d[a]=[]);if(!e[c.username]||k(a,c))d[a].push(c),e[c.username]=a;c.score=c.score||0,c.score+=j[a]}var d={},e={},h={};return b.each(c,function(c){j[c]&&b.each(a,function(a){var d=a[c];b.each(d,function(a){l(c,a)})})}),b.invoke(d,"sort",i),d}var h,i,j;return g=g||{},h=b.map(a,function(a){return a.fetch()}),j=g.related||d,b.isArray(g.related)&&(j={},b.each(g.related,function(a){j[a]=d[a]})),i=g.comparator||function(a,b){return a.score===b.score?a.username>b.username?1:-1:a.score>b.score?-1:1},b.when.apply(null,h).pipe(k).pipe(l)}}(this.lanyrd),function(a){function b(){var b=new a.utils.deferred,c=b.promise(),d={};return a.utils.each(arguments,function(b){a.utils.each(b[0].get("conference.topics"),function(a){d[a.name]?d[a.name]++:d[a.name]=1})}),b.resolve(d),c}"use strict",a.topics=function(d){return d[0].fetched()||(d=a.utils.map(d,function(a){return a.fetch()})),a.utils.when(d).pipe(b)}}(lanyrd);